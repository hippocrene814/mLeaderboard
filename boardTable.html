
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>mLeaderboard_table</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/2.2.0/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
    <script type="text/javascript">

    // get the json url from restful api url: 
    // https://mobile-ci.twitter.biz/view/Android%20Automation%20Dash/job/twitter-android-ui-tests/api/json?pretty=true
    // now just demo from local: restapi.json
    // pass the para "build" to loadJSONDoc(build)
    function getLatestBuild() {
        // Get latest build implementation here
        var jobInfoUrl = "restapi.json";
        var xhr;
        if (window.XMLHttpRequest) {
          xhr = new XMLHttpRequest();
        }
        else {
          xhr = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
            var jobInfo = JSON.parse(xhr.responseText);
            var latestBuild = jobInfo.builds[0].url;
            loadJSONDoc(latestBuild);
          }
        };
        xhr.open("GET", jobInfoUrl, true);
        xhr.send(null);
    }

    // function loadJSONDoc(build) {
    function loadJSONDoc() {
      var xmlhttp;
      if (window.XMLHttpRequest) {
      // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp=new XMLHttpRequest();
      }
      else {
      // code for IE6, IE5
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlhttp.onreadystatechange=function() {
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {
            var txt = xmlhttp.responseText;
            var obj = JSON.parse(txt);
            populateResults(obj);
          }
        }
        // var url = build + "artifact/scripts/mobile-test-reporting/artifacts/testsuites.json";
        var url = "testsuites.json";
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
      }
          
      function populateResults(testResults) {
        //create an array to save each contributor with his/her
        //testCase and testSuite
        //arr[i].contr, arr[i].testCases, arr[i].testSuites
        var arr = new Array();
        for(var testSuite in testResults) {
          var testSuiteData = testResults[testSuite];
          for(var testCase in testSuiteData["test_cases"]) {
            testCaseFull = testSuite + '.' + testCase; // the whole name of test case
            var testCaseData = testSuiteData["test_cases"][testCase];
            for(var i=0; i<testCaseData["contributors"].length; i++) {
              var testCaseContr = testCaseData["contributors"][i];
              var flag = 0;
              for(var j=0; j<arr.length; j++) {
                if(arr[j].contr == testCaseContr) {
                  flag = 1;
                  arr[j].testCases.push(testCaseFull);
                  if((arr[j].testSuites)[arr[j].testSuites.length-1] != testSuite) {
                    arr[j].testSuites.push(testSuite);
                  }
                  break;
                }
              }
              if(flag == 0) {
                var obj = new Object();
                obj.contr = testCaseContr;
                var newTestCases = [testCaseFull];
                obj.testCases = newTestCases;
                var newTestSuites = [testSuite];
                obj.testSuites = newTestSuites;
                arr.push(obj);
              }
            } // contributor, i
          } // testCase
        } // testSuite

        // count the number of each contributor
        for(var j=0; j<arr.length; j++) {
          arr[j].testCaseCount = (arr[j].testCases).length;
          arr[j].testSuiteCount = (arr[j].testSuites).length;
        }

          // construct a level data structure
          // arr = [ { 
          //   "contr" : "yhua@twitter.com", 
          //   "levelCase": {[{suite:"x", case:["x1", "x2", ...]}, {suite:"y", case:["y1", "y2"]}, ...]}
          //   },
          //   {
          //   "contr" : "yyyy@twitter.com", 
          //   "levelCase": {[{suite:"x", case:["x1", "x3", ...]}, {suite:"y", case:["y2", "y4"]}, ...]}
          //   },
          //   ...
          // ]
        for(var j=0; j<arr.length; j++) {
          var arrSuite = new Array();
          for(var i=0; i<arr[j].testSuiteCount; i++) {
            var obj = new Object();
            var tmpSuite = (arr[j].testSuites)[i];
            obj.suite = tmpSuite;
            var arrayCase = new Array();
            for(var k=0; k<arr[j].testCaseCount; k++) {
              var tmpCase = (arr[j].testCases)[k];
              if(tmpCase.indexOf(tmpSuite) > -1) {
                arrayCase.push(tmpCase);
              }
            }
            obj.case = arrayCase;
            arrSuite.push(obj);
          }
          arr[j].levelCase = arrSuite;
        }

        // create a comparator to sort the arr[] by test case count
        function compare(propertyName) {
          return function (object1, object2) {
            var value1 = object1[propertyName];
            var value2 = object2[propertyName];
            if (value2 < value1) {
              return -1;
            }
            else if (value2 > value1) {
              return 1;
            }
            else {
              return 0;
            }
          }
        }
        arr.sort(compare("testCaseCount"));

        var str = "<table class='table table-hover'><tr><th>rank</th><th>contributor</th><th>test cases #</th><th>test suites #</th></tr>";
        for(var j=0; j<arr.length; j++) {
          str = str + "<tr>";
          str = str + ("<td>" + j + "</td>");
          // show the person's profile
          var userName = "https://birdhouse.twitter.biz/people/profile/" + arr[j].contr;
          String(userName);
          str = str + ("<td><a href='"+userName.replace("@twitter.com", "/")+"'>" + arr[j].contr + "</a></td>");
          // show the test case count
          str = str + ("<td>" + arr[j].testCaseCount + "</td>");
          // show the test suite count
          str = str + ("<td>" + arr[j].testSuiteCount + "</td>");
          str = str + ("</tr>");
        }
        str = str + ("</table>");
        document.getElementById("ajaxRefresh").innerHTML = str;
      }

      addEventListener("load", function () {
        loadJSONDoc();
      });
      </script>

  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">mLeaderboard</a>
          <div class="nav-collapse collapse">
            <p class="navbar-text pull-right">
              Logged in as <a href="#" class="navbar-link">Username</a>
            </p>
            <ul class="nav">
              <li><a href="./boardHome.html">Home</a></li>
              <li class="active"><a href="./boardTable.html">Table</a></li>
              <li><a href="./boardChart.html">Chart</a></li>
              <li><a href="./boardTree.html">Tree</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <li class="nav-header">Sidebar</li>
              <li class="active"><a href="#">a</a></li>
              <li><a href="#">b</a></li>
              <li class="nav-header">Sidebar</li>
              <li><a href="#">c</a></li>
            </ul>
          </div><!--/.well -->
        </div><!--/span-->

        <div class="span9">
          <button type="button" class="btn btn-default" onclick="loadJSONDoc()">show</button>
          <button type="button" class="btn btn-default" onclick="getLatestBuild()">test</button>
          <div id="ajaxRefresh" class="bs-example"></div>
        </div>
      </div><!--/row-->

      <hr>

      <footer>
        <p>&copy; Twitter 2014</p>
      </footer>

    </div><!--/.fluid-container-->

  </body>
</html>
